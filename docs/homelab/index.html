<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-gb">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Homelab - Bootstrapping a Secure Infrastructure</title>
    <meta name="generator" content="Hugo 0.36.1" />

    
    <meta name="description" content="Bootstrapping a Secure Infrastructure">
    
    <link rel="canonical" href="/grim/homelab/">
    
    <meta name="author" content="Oliver Mussell">
    

    <meta property="og:url" content="/grim/homelab/">
    <meta property="og:title" content="Bootstrapping a Secure Infrastructure">
    <meta property="og:image" content="/grim/images/logo.png">
    <meta name="apple-mobile-web-app-title" content="Bootstrapping a Secure Infrastructure">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="/grim/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="/grim/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('/grim/fonts/icon.eot');
        src: url('/grim/fonts/icon.eot')
               format('embedded-opentype'),
             url('/grim/fonts/icon.woff')
               format('woff'),
             url('/grim/fonts/icon.ttf')
               format('truetype'),
             url('/grim/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="/grim/stylesheets/application.css">
    <link rel="stylesheet" href="/grim/stylesheets/temporary.css">
    <link rel="stylesheet" href="/grim/stylesheets/palettes.css">
    <link rel="stylesheet" href="/grim/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,700|Roboto&#43;Mono">
    <style>
      body, input {
        font-family: 'Roboto', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Roboto Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="/grim/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-grey palette-accent-dark purple">




<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Homelab
      </div>
    </div>

        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>

</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="/grim/" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="/grim/images/logo.png">
        </div>
      
      <div class="name">
        <strong>Bootstrapping a Secure Infrastructure </strong>
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Overview" href="/grim/overview/">
	
	Overview
</a>



  
</li>



<li>
  
    



<a  title="Design" href="/grim/design/">
	
	Design
</a>



  
</li>



<li>
  
    



<a  title="Implementation" href="/grim/implementation/">
	
	Implementation
</a>



  
</li>



<li>
  
    <span class="section">Homelab</span>
    <ul>
      
        
        



<a  title="godeps" href="/grim/homelab/go-deps/">
	
	godeps
</a>



      
    </ul>
  
</li>


        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Homelab </h1>

			

<h2 id="handling-go-dependencies">Handling Go Dependencies</h2>

<p>During development, you will often use <code>go get</code> to download libraries for import into the program which is useful for development but not so useful when building the finished product. Managing these dependencies over time is a hassle as they change frequently and can sometimes disappear entirely.</p>

<p>The <code>dep</code> tool provides a way of automatically scanning your import statements and evaluating all of the dependencies. It create some files <code>Gopkg.toml</code> and <code>Gopkg.lock</code> which contain the location and latest Git SHA of your dependencies.</p>

<p><code>dep</code> is installed via <code>curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh</code></p>

<p>Run <code>dep init</code> to create the initial files, then as your develop run <code>dep ensure</code> to update dependencies to the latest version.</p>

<p>The <code>dep</code> tool also downloads a copy of all dependencies into a <code>vendor</code> folder at the root of your project. This provides a backup in case a dependency disappears and provides the facility for reproducible builds.</p>

<h2 id="bazel-gazelle">Bazel / Gazelle</h2>

<p>With our dependencies being updated, we would also need to update the WORKSPACE file so that Bazel/Gazelle knows about them as well. Gazelle requires the location and git commit hash in order to pull down the correct dependencies, but this is laborious to perform manually.</p>

<p>Thankfully, we can run a command to have gazelle pull in all of the dependencies from the <code>Gopkg.lock</code> file and update the WORKSPACE file automatically. Bazel will then pull in all of the dependencies correctly without any manual intervention.</p>

<p><code>gazelle update-repos -from_file Gopkg.lock</code></p>

<p>As part of ongoing development, you would periodically run</p>

<p><code>dep ensure</code></p>

<p>followed by</p>

<p><code>gazelle update-repos -from_file Gopkg.lock</code></p>

<p>to keep all of the dependencies up to date and generate the new WORKSPACE file.</p>

<h2 id="packaging-and-distributing-go-applications">Packaging and Distributing Go Applications</h2>

<p>Now that we&rsquo;ve built the go application and its dependencies we now need to package it up to distribute across the infrastructure.</p>

<h2 id="packaging-with-fpm">Packaging with fpm</h2>

<p>The below command is an example of what we would want to run:</p>

<p><code>fpm -s dir -t freebsd -n ~/go_test --version 1.0.0 --prefix /usr/local/bin go_tests</code></p>

<p>But this has a few issues. Rather than putting the finished package into <code>~/go_test</code>, it would be better in a dedicated directory like <code>/var/packages</code> or similar. The version number is hard coded which obviously isn&rsquo;t always going to be correct. You would want to instead have your CI tool set to only run the packaging command when a new tag/release is created, and then have the version number derived from the tag/release number. It also includes the <code>--prefix</code> flag to specify the path to prepend to any files in the package. This is required as when the package is installed/extracted, the files will be extracted to the full path as specified in the package. So in this instance the <code>/usr/local/bin/go_tests</code> file is extracted.</p>

<p>For now, I&rsquo;m getting by with the following command which will overwrite the finished package if it already exists.</p>

<p><code>fpm -f -s dir -t freebsd -n ~/go_test --prefix /usr/local/bin go_tests</code></p>

<h2 id="building-go-programs-using-bazel">Building Go programs using Bazel</h2>

<p>Bazel is a build tool created by Google which operates similarly to their internal build tool, Blaze. It is primarily concerned with generating artifacts from compiled languages like C, C++, Go etc.</p>

<p><code>pkg install -y bazel</code></p>

<p>Bazel requires some files so that it knows what and where to build. As an example, we are going to compile a simple go program with no dependencies (literally print a single string to stdout).</p>

<pre><code>// ~/go/src/github.com/omussell/go_tests/main.go

package main

import &quot;fmt&quot;

func main() {
	fmt.Println(&quot;test&quot;)
}
</code></pre>

<p>A file called WORKSPACE should be created at the root of the directory. This is used by bazel to determine source code locations relative to the WORKSPACE file and differentiate other packages in the same directory. Then a BUILD.bazel file should also be created at the root of the directory.</p>

<h2 id="gazelle">Gazelle</h2>

<p>Instead of creating BUILD files by hand, we can use the Gazelle tool to iterate over a go source tree and dynamically generate BUILD files. We can also let bazel itself run gazelle.</p>

<p>Note that gazelle doesn&rsquo;t work without bash, and the gazelle.bash file has a hardcoded path to <code>/bin/bash</code> which of course is not available on FreeBSD by default.</p>

<pre><code>pkg install -y bash
ln -s /usr/local/bin/bash /bin/bash
</code></pre>

<p>In the WORKSPACE file:</p>

<pre><code>http_archive(
    name = &quot;io_bazel_rules_go&quot;,
    url = &quot;https://github.com/bazelbuild/rules_go/releases/download/0.9.0/rules_go-0.9.0.tar.gz&quot;,
    sha256 = &quot;4d8d6244320dd751590f9100cf39fd7a4b75cd901e1f3ffdfd6f048328883695&quot;,
)
http_archive(
    name = &quot;bazel_gazelle&quot;,
    url = &quot;https://github.com/bazelbuild/bazel-gazelle/releases/download/0.9/bazel-gazelle-0.9.tar.gz&quot;,
    sha256 = &quot;0103991d994db55b3b5d7b06336f8ae355739635e0c2379dea16b8213ea5a223&quot;,
)
load(&quot;@io_bazel_rules_go//go:def.bzl&quot;, &quot;go_rules_dependencies&quot;, &quot;go_register_toolchains&quot;)
go_rules_dependencies()
go_register_toolchains(go_version=&quot;host&quot;)
load(&quot;@bazel_gazelle//:deps.bzl&quot;, &quot;gazelle_dependencies&quot;)
gazelle_dependencies()
</code></pre>

<p>In the BUILD.bazel file:</p>

<pre><code>load(&quot;@bazel_gazelle//:def.bzl&quot;, &quot;gazelle&quot;)

gazelle(
    name = &quot;gazelle&quot;,
    prefix = &quot;github.com/omussell/go_tests&quot;,
)
</code></pre>

<p>Then to run:</p>

<pre><code>bazel run //:gazelle
bazel build //:go_tests
</code></pre>

<p>A built binary should be output to the ~/.cache directory. Once a binary has been built once, Bazel will only build again if the source code changes. Otherwise, any subsequent runs just complete successfully extremely quickly.</p>

<p>When attempting to use bazel in any capacity like <code>bazel run ...</code> or <code>bazel build ...</code> it would give the following error:</p>

<pre><code>ERROR: /root/.cache/bazel/_bazel_root/b3532a61fb0a1349ae431191285a1776/external/io_bazel_rules_go/
BUILD.bazel:7:1: every rule of type go_context_data implicitly depends upon the target '@go_sdk//
:packages.txt', but this target could not be found because of: no such package '@go_sdk//': 
Unsupported operating system: freebsd
ERROR: /root/.cache/bazel/_bazel_root/b3532a61fb0a1349ae431191285a1776/external/io_bazel_rules_go/
BUILD.bazel:7:1: every rule of type go_context_data implicitly depends upon the target '@go_sdk//
:files', but this target could not be found because of: no such package '@go_sdk//': 
Unsupported operating system: freebsd
ERROR: /root/.cache/bazel/_bazel_root/b3532a61fb0a1349ae431191285a1776/external/io_bazel_rules_go/
BUILD.bazel:7:1: every rule of type go_context_data implicitly depends upon the target '@go_sdk//
:tools', but this target could not be found because of: no such package '@go_sdk//': 
Unsupported operating system: freebsd
ERROR: Analysis of target '//:gazelle' failed; build aborted: no such package '@go_sdk//': 
Unsupported operating system: freebsd
</code></pre>

<p>I think this is caused by bazel attempting to download and build go which isn&rsquo;t necessary as we&rsquo;ve already installed via the package anyway. In the WORKSPACE file, change the <code>go_register_toolchains()</code> line to <code>go_register_toolchains(go_version=&quot;host&quot;)</code> as documented at <a href="https://github.com/bazelbuild/rules_go/blob/master/go/toolchains.rst#using-the-installed-go-sdk">https://github.com/bazelbuild/rules_go/blob/master/go/toolchains.rst#using-the-installed-go-sdk</a>. This will force bazel to use the already installed go tools.</p>

<h2 id="ci-with-buildbot">CI with Buildbot</h2>

<p>Example buildbot config:</p>

<pre><code>factory.addStep(steps.Git(repourl='git://github.com/omussell/go_tests.git', mode='incremental'))
factory.addStep(steps.ShellCommand(command=[&quot;go&quot;, &quot;fix&quot;],))
factory.addStep(steps.ShellCommand(command=[&quot;go&quot;, &quot;vet&quot;],))
factory.addStep(steps.ShellCommand(command=[&quot;go&quot;, &quot;fmt&quot;],))
factory.addStep(steps.ShellCommand(command=[&quot;bazel&quot;, &quot;run&quot;, &quot;//:gazelle&quot;],))
factory.addStep(steps.ShellCommand(command=[&quot;bazel&quot;, &quot;build&quot;, &quot;//:go_tests&quot;],))
</code></pre>

<p>I needed to rebuild the buildbot jail because it was borked, and after rebuilding it I was surprised that bazel worked without any more configuration. I just needed to install the git, go and bazel packages and run the buildbot config as described above and it ran through and rebuilt everything from scratch. This is one of the major advantages of keeping the build files (WORKSPACE and BUILD.bazel) alongside the source code. I am sure that if desired, anyone with a bazel setup would be able to build this code as well and the outputs would be identical.</p>

<h2 id="adding-dependencies">Adding dependencies</h2>

<p>In order to have Bazel automatically build dependencies we need to make a some changes to the WORKSPACE file. I&rsquo;ve extended the example program to pull in a library that generates fake data and prints a random name when invoked.</p>

<pre><code>package main

import &quot;github.com/brianvoe/gofakeit&quot;
import &quot;fmt&quot;

func main() {
        gofakeit.Seed(0)
        fmt.Println(gofakeit.Name())
        //      fmt.Println(&quot;test&quot;)
}
</code></pre>

<p>The following needs to be appended to the WORKSPACE file:</p>

<pre><code>load(&quot;@io_bazel_rules_go//go:def.bzl&quot;, &quot;go_repository&quot;)

go_repository(
    name = &quot;com_github_brianvoe_gofakeit&quot;,
    importpath = &quot;github.com/brianvoe/gofakeit&quot;,
    commit = &quot;b0b2ecfdf447299dd6bcdef91001692fc349ce4c&quot;,
)
</code></pre>

<p>The go_repository rule is used when a dependency is required that does not have a BUILD.bzl file in their repo.</p>


			<aside class="copyright" role="note">
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="/grim/design/" title="Design">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Design
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="/grim/implementation/" title="Implementation">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Implementation
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = '';
      var repo_id  = '';
    
    </script>

    <script src="/grim/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    <script src="/grim/javascripts/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

